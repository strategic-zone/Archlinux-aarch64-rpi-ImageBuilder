name: Build Archlinux aarch64 Raspberry Pi Image

on:
  workflow_dispatch:
    inputs:
      rpi_model:
        description: 'Raspberry Pi Model (4 or 5)'
        required: true
        default: '5'
        type: choice
        options:
          - '4'
          - '5'
      upload_to_s3:
        description: 'Upload to S3'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main

permissions:
  contents: write

env:
  RPI_MODEL: ${{ inputs.rpi_model || '5' }}
  IMAGE_NAME_PREFIX: archlinux-rpi
  OS_TIMEZONE: Europe/Paris
  SSH_PUB_KEY_URLS: https://github.com/ts-sz.keys https://gitlab.com/mg.stratzone.keys
  # Optional: Override via repository variables or secrets
  WIFI_SSID: ${{ secrets.WIFI_SSID }}
  WIFI_PASSWORD: ${{ secrets.WIFI_PASSWORD }}
  ZT_NETWORK_ID: ${{ secrets.ZT_NETWORK_ID }}

jobs:
  build-image:
    name: Build and Upload Raspberry Pi Image
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Initialize pacman (required in Arch container)
      - name: Initialize pacman
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm

      # Build the image using build.sh script
      - name: Build Raspberry Pi Image
        run: |
          chmod +x ./build.sh
          ./build.sh --rpi-model ${{ env.RPI_MODEL }}

      # Find the generated image
      - name: Find Generated Image
        id: find_image
        run: |
          # Search in both current directory (new default) and /tmp (fallback)
          IMAGE_FILE=$(find . /tmp -maxdepth 2 -name "rpi-build.*" -type d -exec find {} -name "*.img.zst" \; 2>/dev/null | head -1)
          if [ -z "$IMAGE_FILE" ]; then
            echo "ERROR: No compressed image found!"
            echo "Searched in: $(pwd) and /tmp"
            ls -la $(pwd)/rpi-build.* 2>/dev/null || echo "No rpi-build dirs in $(pwd)"
            ls -la /tmp/rpi-build.* 2>/dev/null || echo "No rpi-build dirs in /tmp"
            exit 1
          fi
          echo "IMAGE_FILE=$IMAGE_FILE" >> $GITHUB_ENV
          echo "IMAGE_NAME=$(basename $IMAGE_FILE)" >> $GITHUB_ENV
          echo "Found image: $IMAGE_FILE"

          # Also find the root password file
          PASSWORD_FILE=$(find . /tmp -maxdepth 2 -name "rpi-build.*" -type d -exec find {} -name "root_password.txt" \; 2>/dev/null | head -1)
          if [ -n "$PASSWORD_FILE" ]; then
            echo "PASSWORD_FILE=$PASSWORD_FILE" >> $GITHUB_ENV
            echo "Root password: $(cat $PASSWORD_FILE)"
          fi

      # Upload compressed image as artifact
      - name: Upload Compressed Image as Artifact
        if: always() && env.IMAGE_FILE != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}
          path: ${{ env.IMAGE_FILE }}
          retention-days: 7
          compression-level: 0

      # Upload root password as artifact
      - name: Upload Root Password as Artifact
        if: always() && env.PASSWORD_FILE != ''
        uses: actions/upload-artifact@v4
        with:
          name: root-password
          path: ${{ env.PASSWORD_FILE }}
          retention-days: 7

      # Upload to S3 (optional)
      - name: Upload Image to S3
        if: (vars.UPLOAD_TO_S3 == 'true' || inputs.upload_to_s3 == true) && env.IMAGE_FILE != ''
        run: |
          echo "Uploading to S3: $IMAGE_NAME"
          s3cmd \
            --access_key="${{ secrets.S3_ACCESS_KEY }}" \
            --secret_key="${{ secrets.S3_SECRET_KEY }}" \
            --host="${{ secrets.CF_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
            --host-bucket="${{ secrets.CF_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
            --progress \
            --stats \
            put "$IMAGE_FILE" s3://${{ vars.CF_BUCKET_NAME }}/

      # Print summary
      - name: Build Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Build Summary"
          echo "=========================================="
          echo "Raspberry Pi Model: ${{ env.RPI_MODEL }}"
          echo "Image Name: ${{ env.IMAGE_NAME }}"
          if [ -n "${{ env.PASSWORD_FILE }}" ]; then
            echo "Root Password: $(cat ${{ env.PASSWORD_FILE }} 2>/dev/null || echo 'Not found')"
          fi
          echo "=========================================="

# ==============================================================================
# The following steps are disabled but kept for reference
# ==============================================================================

      # # Create GitHub Release
      # - name: Create Release
      #   if: false
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: ${{ github.sha }}
      #     release_name: Release ${{ github.sha }}
      #     body: |
      #       üöÄ Custom Archlinux aarch64 image for Raspberry Pi Model ${{ env.RPI_MODEL }}

      # # Notify Discord on Success
      # - name: Notify Success
      #   if: false
      #   run: |
      #     curl -X POST -H "Content-Type: application/json" \
      #       -d "{\"content\": \"üéâ Build succeeded for RPi${{ env.RPI_MODEL }}\"}" \
      #       ${{ secrets.DISCORD_WEBHOOK_URL }}

      # # Notify Discord on Failure
      # - name: Notify Failure
      #   if: false
      #   run: |
      #     curl -X POST -H "Content-Type: application/json" \
      #       -d "{\"content\": \"‚ùå Build failed for RPi${{ env.RPI_MODEL }}\"}" \
      #       ${{ secrets.DISCORD_WEBHOOK_URL }}
